# GuiKeyStandalone - Activity Monitoring Suite

GuiKeyStandalone is a comprehensive Rust-based suite for monitoring user activity (keystrokes, clipboard, active applications) on Windows machines and securely transmitting this data to a local server for review. It consists of three main components:

1.  **Activity Monitor Client Core (`activity_monitor_client_core`)**: A Windows client application that performs the monitoring, encrypts the data, and sends it to the server.
2.  **Local Log Server (`local_log_server`)**: An Actix-web server that receives encrypted logs, stores them in an SQLite database, and provides a web interface to view them.
3.  **Package Generator GUI (`activity_generator_gui`)**: An `egui`-based graphical tool that embeds the client and server binaries and assets. It allows an operator to generate unique encryption keys and client IDs, configure settings, and produce deployment packages for both the client (for remote machines) and the server (for the operator's machine).

## Vision & Purpose

The primary goal of GuiKeyStandalone is to provide a self-hostable solution for activity monitoring where the operator has full control over the data. The `activity_generator_gui` facilitates a "remote-first" deployment:

*   **Operator**: Uses the Generator GUI to create a unique client package.
*   **Server Setup (Operator)**: The operator deploys the `LocalLogServer_Package` (generated by the GUI) on a machine they control. They are responsible for making this server accessible via a public HTTPS URL (e.g., using a tunneling service like Cloudflare Tunnel or ngrok, or by setting up a reverse proxy).
*   **Client Deployment (Operator)**: The operator distributes the `ActivityMonitorClient_Package` (generated by the GUI) to target Windows machines they wish to monitor.
*   **Data Flow**: The client on the target machine monitors activity, encrypts it with the unique key, and sends it to the operator's publicly accessible server URL.
*   **Data Review (Operator)**: The operator can view the collected logs through the web interface provided by their `local_log_server` instance.

**Security and ethical use are paramount. This tool should only be used in compliance with all applicable laws, regulations, and with explicit consent where required.**

## Features

**Package Generator GUI (`activity_generator_gui`)**:
*   Self-contained: Embeds client/server template binaries and server web assets.
*   Generates unique AES-256 encryption keys and UUID client IDs.
*   Configures client to send data to a user-specified public server URL.
*   Configures server's local listening address, database path, and log retention policies.
*   Outputs two distinct packages:
    *   `ActivityMonitorClient_Package`: For distribution to target machines.
    *   `LocalLogServer_Package`: For the operator to run their central server.
*   Generates a `README_IMPORTANT_INSTRUCTIONS.txt` with setup guidance for the generated packages.
*   Cross-platform (GUI itself can run on Windows, Linux, macOS if eframe supports it), but generates Windows executables for client/server.

**Activity Monitor Client Core (`activity_monitor_client_core`)**:
*   Monitors:
    *   Keyboard input (character data and special keys).
    *   Clipboard copy events (text content).
    *   Foreground application name and window title.
*   Data Processing: Aggregates raw events into "sessions" based on active application.
*   Local Caching: Stores logs locally in a JSONL file (`activity_data.jsonl`) if the server is unreachable.
    *   Implements efficient log reading and removal from the cache file using temporary files to avoid full rewrites for large caches.
    *   Configurable local cache retention period and max file size.
*   Encryption: Encrypts log data using AES-256-GCM before transmission.
*   Networking: Sends encrypted log batches to the configured server URL.
    *   Handles retries on network failure.
*   Autostart: Configures itself to run on Windows startup (via Registry Run key).
*   Diagnostics: Detailed internal logging using `tracing`.

**Local Log Server (`local_log_server`)**:
*   API Endpoint: Receives encrypted log batches from clients via `/api/log`.
*   Decryption: Decrypts incoming payloads using the shared AES-256 key.
*   Storage: Stores deserialized log events in an SQLite database.
    *   Database operations are performed on a blocking thread pool to keep the server responsive.
*   Web Interface:
    *   Provides a web UI (accessible via `/logs`) to view collected logs.
    *   Dark theme with teal accents for better readability.
    *   Paginated log display.
*   Log Retention: Automatically deletes old logs from the database based on a configurable retention period.
    *   Deletion check interval is configurable.
*   Diagnostics: Internal logging using `tracing`.

## Project Structure

The project is a Cargo workspace with three main crates:

```
GuiKeyStandalone/
├── Cargo.toml                (Workspace)
├── docs/
│   └── GENERATOR_GUIDE.md    (User guide for the Generator GUI)
│
├── activity_generator_gui/   (The GUI packager)
│   ├── Cargo.toml
│   ├── src/
│   │   ├── app_state.rs
│   │   ├── config_models.rs
│   │   ├── errors.rs
│   │   ├── generator_logic.rs
│   │   ├── main.rs
│   │   └── embedded_assets/  (Contains binaries and server assets to be embedded)
│   │       ├── client_template_payload.bin
│   │       ├── server_template_payload.bin
│   │       └── server_package_content/ (static CSS, HTML templates)
│   │           ├── static/
│   │           └── templates/
│
├── activity_monitor_client_core/ (The Windows monitoring client)
│   ├── Cargo.toml
│   ├── App.manifest
│   ├── build.rs
│   ├── src/ (app_config, core_monitors, errors, event_types, network, processing, services, storage, etc.)
│
├── local_log_server/         (The log receiving server and web UI)
│   ├── Cargo.toml
│   ├── src/ (app_config, application, domain, errors, infrastructure, presentation, etc.)
│   ├── static/ (Original CSS/JS for server UI - copied into generator for embedding)
│   └── templates/ (Original Askama HTML templates - copied into generator for embedding)
│
└── target/                     (Build outputs for all crates)
```

## Getting Started / Building

### Prerequisites
*   Rust toolchain (latest stable recommended).
*   For `activity_monitor_client_core`: Windows development environment (MSVC or GNU toolchain for Windows).
*   (Optional but recommended for generator workflow) A script or manual process to copy compiled client/server binaries and server assets into the `activity_generator_gui/src/embedded_assets/` directory.

### Build Steps

1.  **Build the Client and Server Cores:**
    These are the "template" binaries that the Generator GUI will embed.
    ```
    cargo build --release --package activity_monitor_client_core
    cargo build --release --package local_log_server
    ```

2.  **Prepare Assets for Generator GUI Embedding:**
    *   Locate the compiled binaries (e.g., in `GuiKeyStandalone/target/release/`).
    *   Copy `activity_monitor_client_core.exe` to `GuiKeyStandalone/activity_generator_gui/src/embedded_assets/client_template_payload.bin`.
    *   Copy `local_log_server.exe` to `GuiKeyStandalone/activity_generator_gui/src/embedded_assets/server_template_payload.bin`.
    *   Copy the contents of `GuiKeyStandalone/local_log_server/static/` into `GuiKeyStandalone/activity_generator_gui/src/embedded_assets/server_package_content/static/`.
    *   Copy the contents of `GuiKeyStandalone/local_log_server/templates/` into `GuiKeyStandalone/activity_generator_gui/src/embedded_assets/server_package_content/templates/`.

3.  **Build the Generator GUI:**
    ```
    cargo build --release --package activity_generator_gui
    ```
    The self-contained `activity_generator_gui.exe` will be in `GuiKeyStandalone/target/release/`.

### Running the Generator GUI
1.  Execute the compiled `activity_generator_gui.exe`.
2.  **Configure Public Server URL**: This is crucial. Enter the full HTTPS URL (e.g., `https://your-tunnel.example.com/api/log`) where clients will send data. You are responsible for making your server (from `LocalLogServer_Package`) accessible at this URL.
3.  **Select Output Directory**: Choose where the `ActivityMonitorClient_Package` and `LocalLogServer_Package` will be saved.
4.  Adjust any other server or client settings as needed.
5.  Click "Generate Deployment Packages".
6.  Follow the instructions in the generated `README_IMPORTANT_INSTRUCTIONS.txt` found in your output directory.

## Key Technologies Used
*   **Rust**: Core language for all components.
*   **`egui` (via `eframe`)**: For the cross-platform Package Generator GUI.
*   **`actix-web`**: For the Local Log Server's web framework.
*   **`rusqlite`**: For SQLite database interaction in the server.
*   **`askama`**: For HTML templating in the server's web UI.
*   **`tokio`**: Asynchronous runtime for client and server.
*   **`serde`**: For serialization/deserialization (JSON, TOML).
*   **`aes-gcm`**: For AES-256-GCM encryption of log data.
*   **`windows-sys`**: For low-level Windows API calls in the client (hooks, process info).
*   **`include_dir` / `include_bytes!`**: For embedding assets into the Generator GUI.
*   **`tracing`**: For structured logging across components.

## Important Considerations

*   **Security**:
    *   The generated encryption key is the primary protection for the data payload.
    *   The operator is responsible for securing the machine running the `local_log_server` and ensuring its public endpoint (e.g., via a tunnel) is appropriately configured (ideally with HTTPS).
    *   Consider network security policies, firewalls, and regular software updates.
*   **Ethics and Legality**:
    *   Activity monitoring can have significant privacy implications.
    *   **Always ensure you have explicit consent from individuals whose activity is being monitored if they are not you.**
    *   Comply with all local and international laws and regulations regarding data privacy and employee/user monitoring.
    *   This tool is provided as-is; the user (operator) assumes all responsibility for its ethical and legal use.
*   **Resource Management**:
    *   The client is designed to be relatively lightweight but will consume some CPU and I/O for monitoring and local caching.
    *   The server's resource usage will depend on the number of clients and the volume of logs. SQLite is generally efficient for single-server setups.

## Future Enhancements / To-Do (Potential)
*   **HTTPS for Server**: Directly support or provide clearer guidance for setting up HTTPS for the `local_log_server` (e.g., integration with `rustls` or `openssl` in Actix, or detailed reverse proxy examples).
*   **Generator `build.rs`**: Automate the copying of template binaries and server assets into `src/embedded_assets` as part of the `activity_generator_gui` build process.
*   **Advanced Client Configuration**: Expose more client settings (like `processor_periodic_flush_interval_secs`) in the Generator GUI.
*   **Server UI Filtering/Search**: Add capabilities to filter or search logs in the web UI (e.g., by application name, date range, client ID).
*   **Client Heartbeat/Status**: Implement a mechanism for clients to send periodic status updates to the server.
*   **Remote Client Management (Advanced)**: Basic commands or status requests from server to client (highly complex and security-sensitive).
*   **Improved Error Reporting**: More granular error details in status messages or logs for all components.

## Contributing
Contributions, bug reports, and feature requests are welcome! Please open an issue or pull request on the GitHub repository.
